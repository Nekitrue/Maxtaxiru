<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–¢–∞–∫—Å–∏ MAX - v1.2.1</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --main-color: #fcc200; --bg-color: #f7f7f7; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg-color); margin: 0; padding: 10px 15px 80px 15px; }
        .container { width: 100%; background: white; border-radius: 20px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); box-sizing: border-box; }
        
        /* –ü–µ—Å–æ—á–Ω—ã–µ —á–∞—Å—ã */
        #search-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.95); display: none; flex-direction: column; 
            align-items: center; justify-content: center; z-index: 9999;
        }
        .hourglass { font-size: 70px; animation: flip 2.5s infinite; margin-bottom: 25px; }
        @keyframes flip { 0% { transform: rotate(0deg); } 100% { transform: rotate(180deg); } }

        .field-group { margin-bottom: 18px; position: relative; }
        label { font-size: 14px; font-weight: 600; color: #444; display: block; margin-bottom: 8px; }
        
        input, textarea { width: 100%; padding: 14px; border: 1.5px solid #eee; border-radius: 12px; font-size: 16px; box-sizing: border-box; outline: none; background: #fafafa; }
        input:focus { border-color: var(--main-color); background: #fff; }

        .suggestions { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-radius: 0 0 12px 12px; z-index: 1000; max-height: 220px; overflow-y: auto; display: none; }
        .suggestion-item { padding: 12px 15px; cursor: pointer; border-bottom: 1px solid #f5f5f5; font-size: 14px; }
        .suggestion-item.geo-suggestion { color: #007bff; font-weight: 600; background: #f0f7ff; }

        .price-section { background: #fffcf0; border: 2px solid var(--main-color); border-radius: 18px; padding: 20px; text-align: center; margin: 20px 0; }
        .price-display { font-size: 38px; font-weight: 800; margin-bottom: 15px; }
        .btn-round { width: 50px; height: 50px; border-radius: 50%; border: none; background: #fff; font-size: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        
        .pay-btn { width: 100%; padding: 14px; border-radius: 12px; border: 1.5px solid #eee; background: #fafafa; font-weight: 600; margin-bottom: 10px; }
        .pay-btn.active { border-color: var(--main-color); background: var(--main-color); }

        .order-button { width: 100%; padding: 18px; background: #000; color: white; border: none; border-radius: 15px; font-size: 18px; font-weight: 700; }
        #city-badge { font-size: 10px; color: #28a745; font-weight: 800; margin-bottom: 5px; text-transform: uppercase; display: none; }
    </style>
</head>
<body ontouchmove="handleScrollHide()" onclick="closeAllUI(event)">

<div id="search-overlay"><div class="hourglass">‚åõ</div><div class="search-text">–ò—â–µ–º –º–∞—à–∏–Ω—É...</div></div>

<div class="container">
    <div id="city-badge">üìç –ì–æ—Ä–æ–¥ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω</div>
    <div class="field-group">
        <label>–û—Ç–∫—É–¥–∞:</label>
        <input type="text" id="from" placeholder="–£–ª–∏—Ü–∞ –∏ –¥–æ–º" autocomplete="off" onfocus="showGeoPrompt(this)" oninput="getSuggestions(this)">
        <div class="suggestions"></div>
    </div>

    <div id="extra-stops"></div>
    <button style="color: #007bff; border:none; background:none; font-weight:600; margin-bottom:15px;" id="add-btn" onclick="addExtraStop()">+ –ó–∞–µ—Ö–∞—Ç—å –∫—É–¥–∞-—Ç–æ</button>
    
    <div class="field-group">
        <label>–ö—É–¥–∞:</label>
        <input type="text" id="to" placeholder="–ö—É–¥–∞ –µ–¥–µ–º?" autocomplete="off" oninput="getSuggestions(this)">
        <div class="suggestions"></div>
    </div>

    <div class="price-section">
        <div class="price-display" id="display_price">300 ‚ÇΩ</div>
        <div style="display:flex; justify-content:center; gap:20px;">
            <button class="btn-round" onclick="adjustPrice(-100)">‚àí</button>
            <button class="btn-round" onclick="adjustPrice(100)">+</button>
        </div>
    </div>

    <div class="payment-container">
        <div id="pay-cash" class="pay-btn active" onclick="setPayment('–ù–∞–ª–∏—á–Ω—ã–µ')">üíµ –ù–∞–ª–∏—á–Ω—ã–µ</div>
        <div id="pay-online" class="pay-btn" onclick="setPayment('–ü–µ—Ä–µ–≤–æ–¥')">üì≤ –ü–µ—Ä–µ–≤–æ–¥</div>
    </div>

    <button class="order-button" onclick="confirmOrder()">–ó–ê–ö–ê–ó–ê–¢–¨</button>
</div>

<script>
    let tg = window.Telegram.WebApp;
    tg.expand();

    const DADATA_API_KEY = "6f49e7177e36608d4139b823d71466c86bd7ca4f"; 
    let currentPrice = 300, paymentMethod = '–ù–∞–ª–∏—á–Ω—ã–µ', searchTimeout;
    let detectedCity = null; // –ó–¥–µ—Å—å –±—É–¥–µ–º —Ö—Ä–∞–Ω–∏—Ç—å –≥–æ—Ä–æ–¥ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏

    window.onload = function() { getCurrentLocation(false); }; // –¢–∏—Ö–∏–π –ø–æ–∏—Å–∫ –≥–æ—Ä–æ–¥–∞ –ø—Ä–∏ –≤—Ö–æ–¥–µ

    function handleScrollHide() {
        if (document.activeElement) document.activeElement.blur();
        document.querySelectorAll('.suggestions').forEach(s => s.style.display = 'none');
    }

    function closeAllUI(e) {
        if (!e.target.closest('.field-group')) {
            document.querySelectorAll('.suggestions').forEach(s => s.style.display = 'none');
        }
    }

    function showGeoPrompt(input) {
        if (input.value.length === 0 && !detectedCity) {
            const container = input.nextElementSibling;
            container.innerHTML = '<div class="suggestion-item geo-suggestion" onclick="getCurrentLocation(true)">üìç –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–æ–π –≥–æ—Ä–æ–¥ –∏ –∞–¥—Ä–µ—Å</div>';
            container.style.display = 'block';
        }
    }

    function getCurrentLocation(fillInput = true) {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(async (position) => {
                const lat = position.coords.latitude, lon = position.coords.longitude;
                try {
                    const response = await fetch("https://suggestions.dadata.ru/suggestions/api/4_1/rs/geolocate/address", {
                        method: "POST",
                        headers: { "Content-Type": "application/json", "Accept": "application/json", "Authorization": "Token " + DADATA_API_KEY },
                        body: JSON.stringify({ lat: lat, lon: lon })
                    });
                    const result = await response.json();
                    if (result.suggestions && result.suggestions.length > 0) {
                        const data = result.suggestions[0].data;
                        detectedCity = data.city || data.settlement; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≥–æ—Ä–æ–¥
                        
                        document.getElementById('city-badge').innerText = `üìç ${detectedCity}`;
                        document.getElementById('city-badge').style.display = 'block';

                        if (fillInput) {
                            document.getElementById('from').value = result.suggestions[0].value.replace(data.country + ", " + data.region + ", ", "");
                        }
                    }
                } catch (e) {}
            });
        }
    }

    async function getSuggestions(input) {
        const query = input.value;
        const container = input.nextElementSibling;
        if (query.length < 3) { container.style.display = 'none'; return; }

        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(async () => {
            try {
                // –ü–ê–†–ê–ú–ï–¢–†–´ –§–ò–õ–¨–¢–†–ê–¶–ò–ò
                const body = {
                    query: query,
                    count: 7,
                    from_bound: { value: "city" }, // –ò—â–µ–º –æ—Ç –≥–æ—Ä–æ–¥–∞
                    to_bound: { value: "house" }   // –î–æ –Ω–æ–º–µ—Ä–∞ –¥–æ–º–∞
                };

                // –ï—Å–ª–∏ –≥–æ—Ä–æ–¥ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω, –∂–µ—Å—Ç–∫–æ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –ø–æ–∏—Å–∫ —ç—Ç–∏–º –≥–æ—Ä–æ–¥–æ–º
                if (detectedCity) {
                    body.locations = [{ "city": detectedCity }];
                    body.restrict_value = true; // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –≥–æ—Ä–æ–¥ –≤ —Å—Ç—Ä–æ–∫–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏
                }

                const response = await fetch("https://suggestions.dadata.ru/suggestions/api/4_1/rs/suggest/address", {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Accept": "application/json", "Authorization": "Token " + DADATA_API_KEY },
                    body: JSON.stringify(body)
                });
                
                const result = await response.json();
                container.innerHTML = '';
                if (result.suggestions) {
                    container.style.display = 'block';
                    result.suggestions.forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'suggestion-item';
                        // –£–±–∏—Ä–∞–µ–º —Ä–µ–≥–∏–æ–Ω –∏ —Å—Ç—Ä–∞–Ω—É –∏–∑ –ø–æ–¥—Å–∫–∞–∑–∫–∏ –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã
                        const cleanAddr = item.value.replace(/^.*?,\s*.*?,\s*/, ""); 
                        div.innerText = cleanAddr;
                        div.onclick = () => { 
                            input.value = cleanAddr; 
                            container.style.display = 'none'; 
                            input.blur(); 
                        };
                        container.appendChild(div);
                    });
                }
            } catch (e) {}
        }, 300);
    }

    function adjustPrice(amount) { if (currentPrice + amount >= 100) { currentPrice += amount; document.getElementById('display_price').innerText = currentPrice + " ‚ÇΩ"; } }
    function setPayment(method) { paymentMethod = method; document.getElementById('pay-cash').classList.toggle('active', method === '–ù–∞–ª–∏—á–Ω—ã–µ'); document.getElementById('pay-online').classList.toggle('active', method === '–ü–µ—Ä–µ–≤–æ–¥'); }
    
    function confirmOrder() {
        if (!document.getElementById('from').value || !document.getElementById('to').value) { alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∞–¥—Ä–µ—Å–∞"); return; }
        document.getElementById('search-overlay').style.display = 'flex';
        setTimeout(() => {
            tg.sendData(JSON.stringify({ from: document.getElementById('from').value, to: document.getElementById('to').value, price: currentPrice, city: detectedCity }));
            tg.close();
        }, 8000);
    }
</script>
</body>
</html>
