<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–¢–∞–∫—Å–∏ MAX Neon</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/polyline/1.1.0/polyline.js"></script>
    <style>
        :root { 
            --neon-blue: #00f2ff; 
            --neon-pink: #ff00ff; 
            --bg-dark: #0d0d0d; 
            --card-bg: #1a1a1a;
            --text-color: #e0e0e0;
        }
        
        body { 
            font-family: 'Segoe UI', Roboto, sans-serif; 
            background: var(--bg-dark); 
            color: var(--text-color);
            margin: 0; padding: 10px; 
            display: flex; flex-direction: column;
            min-height: 100vh; overflow-x: hidden;
        }

        .container { 
            width: 100%; background: var(--card-bg); 
            border-radius: 25px; padding: 20px; 
            box-shadow: 0 0 20px rgba(0, 242, 255, 0.1);
            border: 1px solid rgba(0, 242, 255, 0.2);
            box-sizing: border-box;
        }

        #map { 
            height: 250px; width: 100%; 
            border-radius: 20px; margin-bottom: 15px; 
            border: 2px solid var(--neon-blue);
            box-shadow: 0 0 15px var(--neon-blue);
            filter: invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%);
            z-index: 1;
        }

        .field-group { margin-bottom: 20px; position: relative; z-index: 10; }
        label { font-size: 13px; color: var(--neon-blue); font-weight: bold; margin-bottom: 8px; display: block; text-transform: uppercase; }
        
        input { 
            width: 100%; padding: 14px; 
            border: 1px solid rgba(255, 255, 255, 0.1); 
            border-radius: 12px; font-size: 16px; 
            box-sizing: border-box; outline: none; 
            background: rgba(255, 255, 255, 0.05); 
            color: var(--text-color); transition: 0.3s;
        }
        input:focus { border-color: var(--neon-pink); box-shadow: 0 0 10px var(--neon-pink); }

        .suggestions { 
            position: absolute; top: 100%; left: 0; right: 0; 
            background: #1a1a1a; border: 1px solid var(--neon-blue); 
            border-radius: 12px; z-index: 1000; 
            max-height: 200px; overflow-y: auto; 
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
        }
        .suggestion-item { padding: 12px; border-bottom: 1px solid #333; font-size: 14px; cursor: pointer; }
        .suggestion-item:hover { background: #333; color: var(--neon-blue); }
        .geo-item { color: var(--neon-blue); font-weight: bold; border-bottom: 2px solid var(--neon-blue); }

        .price-section { 
            background: #111; border-radius: 20px; padding: 20px; 
            text-align: center; border: 1px solid var(--neon-pink);
            box-shadow: 0 0 15px rgba(255, 0, 255, 0.2); margin-bottom: 20px;
        }
        .price-display { font-size: 36px; font-weight: 900; color: var(--neon-pink); text-shadow: 0 0 10px var(--neon-pink); }
        
        .controls { display: flex; justify-content: center; gap: 20px; margin-top: 10px; }
        .btn-round { 
            width: 50px; height: 50px; border-radius: 50%; border: 2px solid var(--neon-blue); 
            background: transparent; color: var(--neon-blue); font-size: 24px; cursor: pointer;
        }

        .order-button { 
            width: 100%; padding: 18px; background: transparent; 
            color: var(--neon-blue); border: 2px solid var(--neon-blue); 
            border-radius: 15px; font-size: 18px; font-weight: 800; 
            text-transform: uppercase; box-shadow: 0 0 15px var(--neon-blue);
        }

        .custom-marker div {
            background: var(--neon-pink); width: 14px; height: 14px; 
            border-radius: 50%; box-shadow: 0 0 10px var(--neon-pink); border: 2px solid #fff;
        }
    </style>
</head>
<body>

<div class="container">
    <div id="map"></div>

    <div class="field-group">
        <label>–û—Ç–∫—É–¥–∞:</label>
        <input type="text" id="from" placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ" autocomplete="off" 
               onclick="showGeoPrompt(this)" oninput="getSuggestions(this, 'from')">
        <div class="suggestions" style="display:none"></div>
    </div>

    <div class="field-group">
        <label>–ö—É–¥–∞:</label>
        <input type="text" id="to" placeholder="–ö—É–¥–∞ –µ–¥–µ–º?" autocomplete="off" oninput="getSuggestions(this, 'to')">
        <div class="suggestions" style="display:none"></div>
    </div>

    <div class="price-section">
        <div class="price-display" id="display_price">300 ‚ÇΩ</div>
        <div class="controls">
            <button class="btn-round" onclick="adjustPrice(-50)">‚àí</button>
            <button class="btn-round" onclick="adjustPrice(50)">+</button>
        </div>
    </div>

    <button class="order-button" onclick="confirmOrder()">–ó–∞–∫–∞–∑–∞—Ç—å —Ç–∞–∫—Å–∏</button>
</div>

<script>
    let tg = window.Telegram.WebApp;
    tg.expand();
    tg.setHeaderColor("#0d0d0d");

    const DADATA_API_KEY = "6f49e7177e36608d4139b823d71466c86bd7ca4f"; 
    let currentPrice = 300;
    let routePolyline = null;
    let markerFrom, markerTo;
    let coords = { from: null, to: null };

    const map = L.map('map', { zoomControl: false }).setView([56.8389, 60.6057], 13);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);

    function createIcon(color) {
        return L.divIcon({
            className: 'custom-marker',
            html: `<div style="background:${color}; box-shadow: 0 0 10px ${color}"></div>`
        });
    }

    markerFrom = L.marker([56.8389, 60.6057], { icon: createIcon('var(--neon-pink)') }).addTo(map);
    markerTo = L.marker([0,0], { icon: createIcon('var(--neon-blue)') });

    map.on('click', e => {
        markerFrom.setLatLng(e.latlng);
        coords.from = [e.latlng.lat, e.latlng.lng];
        reverseGeocode(e.latlng.lat, e.latlng.lng, 'from');
    });

    // –§—É–Ω–∫—Ü–∏—è –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏
    function showGeoPrompt(input) {
        const container = input.nextElementSibling;
        if (input.value.length === 0) {
            container.innerHTML = `<div class="suggestion-item geo-item" onclick="detectMyLocation()">üìç –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–æ—ë –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</div>`;
            container.style.display = 'block';
        }
    }

    // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ —á–µ—Ä–µ–∑ GPS
    function detectMyLocation() {
        if (!navigator.geolocation) return tg.showAlert("–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è");
        
        document.getElementById('from').nextElementSibling.style.display = 'none';
        
        navigator.geolocation.getCurrentPosition(pos => {
            const lat = pos.coords.latitude;
            const lon = pos.coords.longitude;
            coords.from = [lat, lon];
            markerFrom.setLatLng([lat, lon]);
            map.setView([lat, lon], 15);
            reverseGeocode(lat, lon, 'from');
        }, err => {
            tg.showAlert("–î–æ—Å—Ç—É–ø –∫ GPS –æ—Ç–∫–ª–æ–Ω–µ–Ω");
        });
    }

    async function reverseGeocode(lat, lon, fieldId) {
        const res = await fetch("https://suggestions.dadata.ru/suggestions/api/4_1/rs/geolocate/address", {
            method: "POST",
            headers: { "Content-Type": "application/json", "Authorization": "Token " + DADATA_API_KEY },
            body: JSON.stringify({ lat, lon })
        });
        const data = await res.json();
        if (data.suggestions?.length) {
            document.getElementById(fieldId).value = data.suggestions[0].value;
            updateRoute();
        }
    }

    async function getSuggestions(input, fieldId) {
        const container = input.nextElementSibling;
        if (input.value.length < 3) { 
            if (input.value.length === 0 && fieldId === 'from') showGeoPrompt(input);
            else container.style.display = 'none'; 
            return; 
        }

        clearTimeout(input.timer);
        input.timer = setTimeout(async () => {
            const res = await fetch("https://suggestions.dadata.ru/suggestions/api/4_1/rs/suggest/address", {
                method: "POST",
                headers: { "Content-Type": "application/json", "Authorization": "Token " + DADATA_API_KEY },
                body: JSON.stringify({ query: input.value, count: 5 })
            });
            const data = await res.json();
            container.innerHTML = '';
            container.style.display = 'block';
            data.suggestions.forEach(s => {
                const div = document.createElement('div');
                div.className = 'suggestion-item';
                div.innerText = s.value;
                div.onclick = () => {
                    input.value = s.value;
                    container.style.display = 'none';
                    coords[fieldId] = [s.data.geo_lat, s.data.geo_lon];
                    if(fieldId === 'to') {
                        markerTo.setLatLng(coords.to).addTo(map);
                    } else {
                        markerFrom.setLatLng(coords.from);
                    }
                    updateRoute();
                };
                container.appendChild(div);
            });
        }, 400);
    }

    async function updateRoute() {
        if (!coords.from || !coords.to) return;
        const url = `https://router.project-osrm.org/route/v1/driving/${coords.from[1]},${coords.from[0]};${coords.to[1]},${coords.to[0]}?overview=full`;
        const res = await fetch(url);
        const data = await res.json();

        if (data.routes?.length) {
            if (routePolyline) map.removeLayer(routePolyline);
            const points = polyline.decode(data.routes[0].geometry);
            routePolyline = L.polyline(points, {
                color: 'var(--neon-blue)', weight: 5, opacity: 0.7,
                dashArray: '10, 15', lineCap: 'round'
            }).addTo(map);

            let offset = 0;
            function animate() {
                offset++;
                if(routePolyline) {
                    routePolyline.setStyle({ dashOffset: -offset });
                    requestAnimationFrame(animate);
                }
            }
            animate();
            map.fitBounds(routePolyline.getBounds(), { padding: [30, 30] });
        }
    }

    function adjustPrice(val) {
        currentPrice = Math.max(100, currentPrice + val);
        document.getElementById('display_price').innerText = currentPrice + " ‚ÇΩ";
    }

    function confirmOrder() {
        const from = document.getElementById('from').value;
        const to = document.getElementById('to').value;
        if (!from || !to) return tg.showAlert("–£–∫–∞–∂–∏—Ç–µ –º–∞—Ä—à—Ä—É—Ç");
        tg.sendData(JSON.stringify({ from, to, price: currentPrice, lat: coords.from[0], lon: coords.from[1] }));
        tg.close();
    }
</script>
</body>
</html>
