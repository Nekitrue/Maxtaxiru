<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LIT TAXI</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/suggestions-jquery@21.12.0/dist/css/suggestions.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/suggestions-jquery@21.12.0/dist/js/jquery.suggestions.min.js"></script>

    <style>
        :root {
            --bg-color: #000000;
            --card-bg: #1c1c1e;
            --text-color: #ffffff;
            --accent-color: #F7E309; /* Яркий желтый LIT */
            --accent-text: #000000;
            --input-bg: #2c2c2e;
            --hint-color: #8e8e93;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }

        h1 {
            text-align: center;
            color: var(--accent-color);
            font-style: italic;
            text-transform: uppercase;
            margin-bottom: 20px;
            letter-spacing: 2px;
        }

        .input-group {
            margin-bottom: 15px;
            position: relative;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-size: 12px;
            color: var(--hint-color);
            text-transform: uppercase;
            font-weight: bold;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            background-color: var(--input-bg);
            border: 1px solid transparent;
            border-radius: 12px;
            color: var(--text-color);
            font-size: 16px;
            box-sizing: border-box;
            outline: none;
            transition: border-color 0.3s;
        }

        input:focus, textarea:focus {
            border-color: var(--accent-color);
        }

        /* Стили для DaData подсказок под темную тему */
        .suggestions-wrapper .suggestions-suggestions {
            background: var(--card-bg);
            border: 1px solid var(--accent-color);
            color: var(--text-color);
        }
        .suggestions-suggestion:hover {
            background: var(--accent-color);
            color: var(--accent-text);
        }
        /* Цвет текста подсказок */
        .suggestions-suggestion {
            color: white;
        }
        .suggestions-value {
            color: var(--accent-color);
        }

        .price-card {
            background: linear-gradient(145deg, #1c1c1e, #2c2c2e);
            padding: 20px;
            border-radius: 16px;
            margin: 20px 0;
            text-align: center;
            border: 1px solid #333;
        }

        .price-label {
            font-size: 14px;
            color: var(--hint-color);
            margin-bottom: 5px;
        }

        .price-value {
            font-size: 36px;
            font-weight: 800;
            color: var(--accent-color);
        }

        .old-price {
            text-decoration: line-through;
            color: var(--hint-color);
            font-size: 14px;
            margin-top: 5px;
        }

        .btn-add-stop {
            background: transparent;
            border: 1px dashed var(--hint-color);
            color: var(--hint-color);
            padding: 8px;
            width: 100%;
            border-radius: 8px;
            margin-bottom: 15px;
            cursor: pointer;
        }
        
        .hidden { display: none; }

        /* MainButton контролируется через TG API, но добавим заглушку для теста в браузере */
        #order-btn-placeholder {
            background-color: var(--accent-color);
            color: var(--accent-text);
            font-weight: bold;
            text-transform: uppercase;
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            margin-top: 20px;
            cursor: pointer;
            display: none; /* Скрыто по умолчанию, покажем при расчете */
        }
    </style>
</head>
<body>

    <h1>LIT TAXI</h1>

    <div class="input-group">
        <label>Откуда</label>
        <input type="text" id="address-from" placeholder="Улица, дом">
    </div>

    <button class="btn-add-stop" onclick="toggleStop()">+ Заехать (промежуточный адрес)</button>

    <div class="input-group hidden" id="stop-container">
        <label>Заехать</label>
        <input type="text" id="address-stop" placeholder="Промежуточный адрес">
    </div>

    <div class="input-group">
        <label>Куда</label>
        <input type="text" id="address-to" placeholder="Куда едем?">
    </div>

    <div class="input-group">
        <label>Комментарий</label>
        <textarea id="comment" rows="2" placeholder="Подъезд, код двери..."></textarea>
    </div>

    <div class="input-group">
        <label>Оплата</label>
        <select id="payment-method">
            <option value="card">Карта</option>
            <option value="cash">Наличные</option>
            <option value="sbp">СБП</option>
        </select>
    </div>

    <div class="price-card">
        <div class="price-label">Ваша цена (LIT)</div>
        <div class="price-value" id="final-price">0 ₽</div>
        <div class="old-price" id="yandex-price">Яндекс: ...</div>
    </div>

    <div id="order-btn-placeholder">Заказать такси</div>

<script>
    // --- НАСТРОЙКИ ---
    // Вставлен ключ пользователя
    const dadataToken = "6f49e7177e36608d4139b823d71466c86bd7ca4f"; 
    
    // Тарифы (можно менять)
    const baseRate = 100; // Посадка
    const kmRate = 25;    // Цена за км
    
    let tg = window.Telegram.WebApp;
    tg.expand();

    // Переменные координат
    let coords = {
        from: null,
        stop: null,
        to: null
    };

    // Настройка MainButton (нативная кнопка Telegram)
    tg.MainButton.text = "ЗАКАЗАТЬ ТАКСИ";
    tg.MainButton.color = "#F7E309"; // Желтый
    tg.MainButton.textColor = "#000000"; // Черный текст

    // Функция инициализации DaData
    function initDaData(id, type) {
        $("#" + id).suggestions({
            token: dadataToken,
            type: "ADDRESS",
            // Ограничим поиск областью, если нужно, или оставим по всей стране
            /* constraints: {
                locations: { city: "Москва" } 
            }, */
            onSelect: function(suggestion) {
                // Сохраняем координаты
                if(suggestion.data.geo_lat && suggestion.data.geo_lon) {
                    coords[type] = {
                        lat: parseFloat(suggestion.data.geo_lat),
                        lon: parseFloat(suggestion.data.geo_lon)
                    };
                    calculatePrice();
                }
            }
        });
    }

    // Запускаем подсказки
    $(document).ready(function(){
        initDaData("address-from", "from");
        initDaData("address-stop", "stop");
        initDaData("address-to", "to");

        // Геолокация при старте
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                // Можно добавить логику обратного геокодирования
            });
        }
    });

    function toggleStop() {
        const stopDiv = document.getElementById('stop-container');
        if (stopDiv.classList.contains('hidden')) {
            stopDiv.classList.remove('hidden');
        } else {
            stopDiv.classList.add('hidden');
            coords.stop = null; // сброс координат промежуточной
            document.getElementById('address-stop').value = '';
            calculatePrice();
        }
    }

    // Расчет расстояния (Haversine formula)
    function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
        var R = 6371; 
        var dLat = deg2rad(lat2-lat1);  
        var dLon = deg2rad(lon2-lon1); 
        var a = 
            Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2); 
        var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
        var d = R * c; 
        return d;
    }

    function deg2rad(deg) {
        return deg * (Math.PI/180)
    }

    function calculatePrice() {
        // Считаем только если есть точки А и Б
        if (!coords.from || !coords.to) {
            return;
        }

        let totalDist = 0;

        // Расчет с учетом промежуточной точки
        if (coords.stop) {
            totalDist += getDistanceFromLatLonInKm(coords.from.lat, coords.from.lon, coords.stop.lat, coords.stop.lon);
            totalDist += getDistanceFromLatLonInKm(coords.stop.lat, coords.stop.lon, coords.to.lat, coords.to.lon);
        } else {
            totalDist += getDistanceFromLatLonInKm(coords.from.lat, coords.from.lon, coords.to.lat, coords.to.lon);
        }

        // Коэффициент "кривизны дорог" (так как считаем по прямой, умножаем на 1.4 для реалистичности)
        totalDist = totalDist * 1.4;

        // Расчет цены
        let estimatedPrice = baseRate + (totalDist * kmRate);
        
        // Округляем до десятков (например 123 -> 130)
        estimatedPrice = Math.ceil(estimatedPrice / 10) * 10;
        if (estimatedPrice < 150) estimatedPrice = 150; // Минималка

        // Имитация цены Яндекса (+10% к нашей)
        // То есть наша цена - это 90% от Яндекса
        let yandexPrice = Math.ceil((estimatedPrice / 0.9) / 10) * 10;

        // Вывод
        document.getElementById('final-price').innerText = estimatedPrice + " ₽";
        document.getElementById('yandex-price').innerText = "Яндекс: ~" + yandexPrice + " ₽";

        // Показываем кнопку заказа Telegram
        tg.MainButton.show();
        // Показываем кнопку-заглушку для браузера
        document.getElementById('order-btn-placeholder').style.display = "block";
        
        // Передача данных в кнопку Telegram
        tg.MainButton.setParams({
            text_color: "#000000",
            color: "#F7E309",
            text: `ЗАКАЗАТЬ ЗА ${estimatedPrice} ₽`
        });
    }

    // Обработка клика (для браузера)
    document.getElementById('order-btn-placeholder').onclick = function() {
        alert("В Telegram это отправит данные боту: " + document.getElementById('final-price').innerText);
    };

    // Обработка клика (для Telegram)
    tg.MainButton.onClick(function() {
        const data = {
            from: document.getElementById('address-from').value,
            to: document.getElementById('address-to').value,
            stop: document.getElementById('address-stop').value,
            price: document.getElementById('final-price').innerText,
            comment: document.getElementById('comment').value,
            payment: document.getElementById('payment-method').value
        };
        tg.sendData(JSON.stringify(data));
    });

</script>
</body>
</html>
