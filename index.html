<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Такси MAX - Eternal Liquid</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { 
            --aqua-bright: #0a9396;
            --neon-blue: #94d2bd;
            --glass-bg: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.15);
            --pulse-intensity: 0.2; /* Начальное значение больше нуля */
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: 'Montserrat', sans-serif; 
            background: #001219;
            color: #fff; margin: 0; padding: 15px; 
            min-height: 100vh; overflow: hidden;
            display: flex; flex-direction: column;
            filter: hue-rotate(calc(var(--pulse-intensity) * 15deg));
            transition: filter 0.2s linear;
        }

        .aqua-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1; 
            background: radial-gradient(circle at center, 
                calc(#005f73 + (var(--pulse-intensity) * 35px)) 0%, 
                #001219 100%);
        }

        .drop {
            position: absolute; background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(5px); border-radius: 50%;
            animation: flow 15s infinite linear;
            box-shadow: 0 0 calc(var(--pulse-intensity) * 35px) var(--neon-blue);
            transform: scale(calc(0.6 + var(--pulse-intensity) * 1.2));
            opacity: calc(0.2 + var(--pulse-intensity) * 0.8);
        }

        @keyframes flow {
            0% { transform: translateY(110vh); }
            100% { transform: translateY(-20vh); }
        }

        .music-switch-container {
            position: fixed; top: 15px; right: 15px;
            z-index: 2000; display: flex; align-items: center; gap: 8px;
            background: var(--glass-bg); padding: 8px 12px;
            border-radius: 20px; border: 1px solid var(--glass-border);
            backdrop-filter: blur(10px);
            box-shadow: 0 0 calc(var(--pulse-intensity) * 20px) var(--aqua-bright);
        }

        .switch { position: relative; display: inline-block; width: 40px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(255,255,255,0.1); transition: .4s; border-radius: 20px;
        }
        .slider:before {
            position: absolute; content: ""; height: 14px; width: 14px;
            left: 3px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--aqua-bright); }
        input:checked + .slider:before { transform: translateX(18px); }

        .container { 
            background: rgba(255, 255, 255, calc(0.04 + var(--pulse-intensity) * 0.08));
            backdrop-filter: blur(25px); 
            border: 1px solid rgba(255,255,255, calc(0.1 + var(--pulse-intensity) * 0.2)); 
            border-radius: 30px; padding: 20px; margin-top: 50px;
            position: relative; z-index: 10;
            transform: scale(calc(1 + var(--pulse-intensity) * 0.03));
            box-shadow: 0 20px 50px rgba(0,0,0,0.5), 
                        inset 0 0 calc(var(--pulse-intensity) * 30px) rgba(10, 147, 150, 0.2);
            transition: transform 0.1s ease-out, background 0.1s ease-out;
        }

        label { 
            font-size: 11px; font-weight: 800; color: var(--neon-blue); 
            text-transform: uppercase; display: block; margin-bottom: 8px;
            text-shadow: 0 0 calc(var(--pulse-intensity) * 12px) var(--neon-blue);
        }
        
        input[type="text"] { 
            width: 100%; padding: 16px; border: 1px solid var(--glass-border); 
            border-radius: 18px; background: rgba(0, 18, 25, 0.5); 
            color: #fff; outline: none; font-size: 15px;
        }

        .class-btn.active, .pay-btn.active, .order-button {
            filter: drop-shadow(0 0 calc(var(--pulse-intensity) * 15px) var(--neon-blue));
            transform: scale(calc(1 + var(--pulse-intensity) * 0.04));
        }

        .price-display { 
            font-size: 38px; font-weight: 800; color: #ee9b00; 
            text-shadow: 0 0 calc(var(--pulse-intensity) * 20px) #ee9b00;
            display: inline-block;
            transform: scale(calc(1 + var(--pulse-intensity) * 0.15));
        }

        .order-button { 
            width: 100%; padding: 22px; 
            background: linear-gradient(90deg, #ee9b00, #ca6702); 
            color: #fff; border: none; border-radius: 22px; 
            font-size: 20px; font-weight: 800; text-transform: uppercase;
            margin-top: 15px;
        }

        .suggestions { 
            position: absolute; top: 100%; left: 0; right: 0; 
            background: rgba(0, 18, 25, 0.98); border-radius: 18px; z-index: 1000; display: none;
        }
    </style>
</head>
<body onclick="closeAllUI(event)">

<div class="aqua-bg" id="aqua-bg"></div>

<div class="music-switch-container">
    <span style="font-size: 9px; font-weight: 800; color: var(--neon-blue);">AQUA MODE</span>
    <label class="switch">
        <input type="checkbox" id="music-toggle" onchange="manualMusicControl()">
        <span class="slider"></span>
    </label>
</div>

<audio id="bg-audio" loop preload="auto" crossorigin="anonymous">
    <source src="Ringtone.mp3" type="audio/mpeg">
</audio>

<div class="container">
    <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
        <div style="font-size: 10px; color: var(--neon-blue); font-weight: 800;">LIVING GLASS</div>
        <div id="city-status" onclick="toggleCitySelector()" style="font-size: 10px; color: #94d2bd; text-decoration: underline; font-weight: 800;">ОПРЕДЕЛЕНИЕ ГОРОДА...</div>
    </div>
    
    <div class="field-group">
        <label>Откуда:</label>
        <input type="text" id="from" placeholder="Улица и дом" oninput="getSuggestions(this)" onfocus="autoPlayMusic()">
        <div class="suggestions"></div>
    </div>

    <div class="field-group">
        <label>Куда:</label>
        <input type="text" id="to" placeholder="Место назначения" oninput="getSuggestions(this)" onfocus="autoPlayMusic()">
        <div class="suggestions"></div>
    </div>

    <div class="field-group">
        <label>Класс такси:</label>
        <div style="display: flex; gap: 10px;">
            <div class="class-btn active" style="flex:1; padding:15px; border-radius:18px; border:1px solid var(--glass-border); text-align:center; font-size:11px; font-weight:800;" onclick="selectClass(this, 500)">ЭКОНОМ</div>
            <div class="class-btn" style="flex:1; padding:15px; border-radius:18px; border:1px solid var(--glass-border); text-align:center; font-size:11px; font-weight:800;" onclick="selectClass(this, 850)">БИЗНЕС</div>
        </div>
    </div>

    <div style="text-align: center; margin: 30px 0;">
        <span class="price-display" id="display_price">500 ₽</span>
    </div>

    <div style="display:flex; gap:10px; margin-bottom: 25px;">
        <div id="pay-cash" class="pay-btn active" style="flex:1; padding:18px; border-radius:20px; border:1px solid var(--glass-border); text-align:center; font-size:12px; font-weight:800;" onclick="setPayment('Наличные')">CASH</div>
        <div id="pay-online" class="pay-btn" style="flex:1; padding:18px; border-radius:20px; border:1px solid var(--glass-border); text-align:center; font-size:12px; font-weight:800;" onclick="setPayment('СБП')">СБП</div>
    </div>

    <button class="order-button" onclick="confirmOrder()">ЗАКАЗАТЬ</button>
</div>

<script>
    let tg = window.Telegram.WebApp;
    tg.expand();

    const audio = document.getElementById('bg-audio');
    const musicToggle = document.getElementById('music-toggle');
    let audioContext, analyser, frequencyData, isPlaying = false, pulseFrame;
    
    // Автономный ритм
    let autoPulsePhase = 0;

    window.onload = () => {
        const saved = localStorage.getItem('musicEnabled');
        musicToggle.checked = (saved === null) ? true : (saved === 'true');
        createDrops();
        // Запускаем цикл анимации сразу
        updatePulseLoop();
    };

    function closeAllUI(e) {
        if (!e.target.closest('.field-group')) {
            document.querySelectorAll('.suggestions').forEach(s => s.style.display = 'none');
            document.querySelectorAll('input').forEach(i => i.blur());
        }
    }

    function autoPlayMusic() { if (!isPlaying && musicToggle.checked) startMusic(); }

    function manualMusicControl() {
        localStorage.setItem('musicEnabled', musicToggle.checked);
        musicToggle.checked ? startMusic() : stopMusic();
    }

    function startMusic() {
        if (!audioContext) {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioContext.createAnalyser();
            analyser.fftSize = 32;
            frequencyData = new Uint8Array(analyser.frequencyBinCount);
            let source = audioContext.createMediaElementSource(audio);
            source.connect(analyser);
            analyser.connect(audioContext.destination);
        }
        audio.play().then(() => { isPlaying = true; }).catch(() => {});
    }

    function stopMusic() {
        audio.pause(); 
        isPlaying = false;
    }

    function updatePulseLoop() {
        let intensity = 0;

        if (isPlaying && analyser) {
            // Режим музыки: реакция на басы
            analyser.getByteFrequencyData(frequencyData);
            let raw = frequencyData[0] / 255;
            intensity = Math.pow(raw, 1.5) * 1.4;
        } else {
            // Автономный режим: мягкая синусоида
            autoPulsePhase += 0.03; // Скорость "дыхания"
            intensity = (Math.sin(autoPulsePhase) + 1) / 2; // От 0 до 1
            intensity = 0.15 + intensity * 0.25; // Ограничиваем диапазон для спокойного режима
        }
        
        document.documentElement.style.setProperty('--pulse-intensity', intensity.toFixed(3));
        pulseFrame = requestAnimationFrame(updatePulseLoop);
    }

    function createDrops() {
        const bg = document.getElementById('aqua-bg');
        for(let i=0; i<18; i++) {
            let d = document.createElement('div'); d.className = 'drop';
            let s = Math.random() * 90 + 30;
            d.style.width = d.style.height = s + 'px';
            d.style.left = Math.random() * 100 + 'vw';
            d.style.top = Math.random() * 100 + 'vh';
            d.style.animationDuration = (Math.random() * 15 + 8) + 's';
            bg.appendChild(d);
        }
    }

    // Сокращенные вспомогательные функции (сохраните логику DaData из прошлых версий)
    function selectClass(el, p) {
        document.querySelectorAll('.class-btn').forEach(b => b.classList.remove('active'));
        el.classList.add('active');
        document.getElementById('display_price').innerText = p + " ₽";
    }
    function setPayment(m) {
        document.querySelectorAll('.pay-btn').forEach(b => b.classList.remove('active'));
        event.currentTarget.classList.add('active');
    }
    function confirmOrder() {
        tg.sendData(JSON.stringify({ order: "ready" }));
    }
</script>
</body>
</html>
