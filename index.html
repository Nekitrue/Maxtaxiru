<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–¢–∞–∫—Å–∏ MAX Neon Light</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/polyline/1.1.0/polyline.js"></script>
    <style>
        :root { 
            --neon-blue: #00f2ff; 
            --neon-pink: #ff00ff; 
            --bg-dark: #0d0d0d; 
            --card-bg: #1a1a1a;
            --input-bg: rgba(255, 255, 255, 0.07);
        }
        
        * { box-sizing: border-box; } /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –Ω–∞–ø–æ–ª–∑–∞–Ω–∏–µ –∑–∞ —Å—á–µ—Ç —É—á–µ—Ç–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö –æ—Ç—Å—Ç—É–ø–æ–≤ */

        body { 
            font-family: 'Segoe UI', Roboto, sans-serif; 
            background: var(--bg-dark); 
            color: #e0e0e0;
            margin: 0; padding: 10px; 
            display: flex; flex-direction: column;
            min-height: 100vh;
        }

        .container { 
            width: 100%; background: var(--card-bg); 
            border-radius: 25px; padding: 15px; 
            border: 1px solid rgba(0, 242, 255, 0.2);
            padding-bottom: 30px; /* –û—Ç—Å—Ç—É–ø —Å–Ω–∏–∑—É –¥–ª—è –∫–æ–º—Ñ–æ—Ä—Ç–Ω–æ–≥–æ —Å–∫—Ä–æ–ª–ª–∞ */
        }

        #map { 
            height: 220px; width: 100%; 
            border-radius: 18px; margin-bottom: 20px; 
            border: 2px solid var(--neon-blue);
            box-shadow: 0 0 10px var(--neon-blue);
            z-index: 1;
        }

        .field-group { margin-bottom: 18px; position: relative; z-index: 5; }
        label { font-size: 11px; color: var(--neon-blue); font-weight: bold; margin-bottom: 6px; display: block; text-transform: uppercase; letter-spacing: 0.5px; }
        
        input { 
            width: 100%; padding: 12px 15px; 
            border: 1px solid rgba(255, 255, 255, 0.15); 
            border-radius: 12px; font-size: 15px; 
            outline: none; background: var(--input-bg); 
            color: white; transition: 0.2s;
        }
        input:focus { border-color: var(--neon-pink); background: rgba(255, 255, 255, 0.1); }

        .suggestions { 
            position: absolute; top: 100%; left: 0; right: 0; 
            background: #222; border: 1px solid var(--neon-blue); 
            border-radius: 10px; z-index: 1000; 
            max-height: 180px; overflow-y: auto; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.6);
        }
        .suggestion-item { padding: 12px; border-bottom: 1px solid #333; font-size: 13px; cursor: pointer; }
        .geo-item { color: var(--neon-blue); font-weight: bold; }

        .price-section { 
            background: #111; border-radius: 18px; padding: 15px; 
            text-align: center; border: 1px solid var(--neon-pink);
            margin-top: 10px; margin-bottom: 20px;
        }
        .price-display { font-size: 32px; font-weight: 900; color: var(--neon-pink); text-shadow: 0 0 8px var(--neon-pink); }
        
        .controls { display: flex; justify-content: center; gap: 25px; margin-top: 8px; }
        .btn-round { 
            width: 45px; height: 45px; border-radius: 50%; border: 2px solid var(--neon-blue); 
            background: transparent; color: var(--neon-blue); font-size: 22px; cursor: pointer;
        }

        .order-button { 
            width: 100%; padding: 16px; background: transparent; 
            color: var(--neon-blue); border: 2px solid var(--neon-blue); 
            border-radius: 15px; font-size: 18px; font-weight: 800; 
            text-transform: uppercase; box-shadow: 0 0 12px var(--neon-blue);
        }

        .custom-marker div {
            background: var(--neon-pink); width: 14px; height: 14px; 
            border-radius: 50%; border: 2px solid #fff; box-shadow: 0 0 8px var(--neon-pink);
        }
    </style>
</head>
<body>

<div class="container">
    <div id="map"></div>

    <div class="field-group">
        <label>–û—Ç–∫—É–¥–∞:</label>
        <input type="text" id="from" placeholder="–¢–æ—á–∫–∞ –ê" autocomplete="off" onclick="showGeoPrompt(this)" oninput="getSuggestions(this, 'from')">
        <div class="suggestions" style="display:none"></div>
    </div>

    <div class="field-group">
        <label>–ö—É–¥–∞:</label>
        <input type="text" id="to" placeholder="–¢–æ—á–∫–∞ –ë" autocomplete="off" oninput="getSuggestions(this, 'to')">
        <div class="suggestions" style="display:none"></div>
    </div>

    <div class="price-section">
        <div class="price-display" id="display_price">300 ‚ÇΩ</div>
        <div class="controls">
            <button class="btn-round" onclick="adjustPrice(-50)">‚àí</button>
            <button class="btn-round" onclick="adjustPrice(50)">+</button>
        </div>
    </div>

    <button class="order-button" onclick="confirmOrder()">–ó–∞–∫–∞–∑–∞—Ç—å</button>
</div>

<script>
    let tg = window.Telegram.WebApp;
    tg.expand();
    tg.setHeaderColor("#0d0d0d");

    const DADATA_API_KEY = "6f49e7177e36608d4139b823d71466c86bd7ca4f"; 
    let currentPrice = 300;
    let routePolyline = null;
    let markerFrom, markerTo;
    let coords = { from: null, to: null };

    // –°–≤–µ—Ç–ª–∞—è –∫–∞—Ä—Ç–∞ —Å –≤–∏–¥–∏–º—ã–º–∏ –¥–æ–º–∞–º–∏ (CartoDB Voyager)
    const map = L.map('map', { zoomControl: false }).setView([56.8389, 60.6057], 13);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
        attribution: '¬©OpenStreetMap ¬©CartoDB'
    }).addTo(map);

    function createIcon(color) {
        return L.divIcon({
            className: 'custom-marker',
            html: `<div style="background:${color}"></div>`
        });
    }

    markerFrom = L.marker([56.8389, 60.6057], { icon: createIcon('var(--neon-pink)') }).addTo(map);
    markerTo = L.marker([0,0], { icon: createIcon('var(--neon-blue)') });

    map.on('click', e => {
        markerFrom.setLatLng(e.latlng);
        coords.from = [e.latlng.lat, e.latlng.lng];
        reverseGeocode(e.latlng.lat, e.latlng.lng, 'from');
    });

    function showGeoPrompt(input) {
        const container = input.nextElementSibling;
        if (input.value.length === 0) {
            container.innerHTML = `<div class="suggestion-item geo-item" onclick="detectMyLocation()">üìç –ú–æ—ë –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</div>`;
            container.style.display = 'block';
        }
    }

    function detectMyLocation() {
        if (!navigator.geolocation) return;
        document.getElementById('from').nextElementSibling.style.display = 'none';
        navigator.geolocation.getCurrentPosition(pos => {
            const lat = pos.coords.latitude;
            const lon = pos.coords.longitude;
            coords.from = [lat, lon];
            markerFrom.setLatLng([lat, lon]);
            map.setView([lat, lon], 16);
            reverseGeocode(lat, lon, 'from');
        });
    }

    async function reverseGeocode(lat, lon, fieldId) {
        const res = await fetch("https://suggestions.dadata.ru/suggestions/api/4_1/rs/geolocate/address", {
            method: "POST",
            headers: { "Content-Type": "application/json", "Authorization": "Token " + DADATA_API_KEY },
            body: JSON.stringify({ lat, lon })
        });
        const data = await res.json();
        if (data.suggestions?.length) {
            document.getElementById(fieldId).value = data.suggestions[0].value;
            updateRoute();
        }
    }

    async function getSuggestions(input, fieldId) {
        const container = input.nextElementSibling;
        if (input.value.length < 3) { 
            if (input.value.length === 0 && fieldId === 'from') showGeoPrompt(input);
            else container.style.display = 'none'; 
            return; 
        }
        clearTimeout(input.timer);
        input.timer = setTimeout(async () => {
            const res = await fetch("https://suggestions.dadata.ru/suggestions/api/4_1/rs/suggest/address", {
                method: "POST",
                headers: { "Content-Type": "application/json", "Authorization": "Token " + DADATA_API_KEY },
                body: JSON.stringify({ query: input.value, count: 5 })
            });
            const data = await res.json();
            container.innerHTML = '';
            container.style.display = 'block';
            data.suggestions.forEach(s => {
                const div = document.createElement('div');
                div.className = 'suggestion-item';
                div.innerText = s.value;
                div.onclick = () => {
                    input.value = s.value;
                    container.style.display = 'none';
                    coords[fieldId] = [parseFloat(s.data.geo_lat), parseFloat(s.data.geo_lon)];
                    if(fieldId === 'to') {
                        markerTo.setLatLng(coords.to).addTo(map);
                    } else {
                        markerFrom.setLatLng(coords.from);
                    }
                    updateRoute();
                };
                container.appendChild(div);
            });
        }, 400);
    }

    async function updateRoute() {
        if (!coords.from || !coords.to) return;
        const url = `https://router.project-osrm.org/route/v1/driving/${coords.from[1]},${coords.from[0]};${coords.to[1]},${coords.to[0]}?overview=full`;
        const res = await fetch(url);
        const data = await res.json();
        if (data.routes?.length) {
            if (routePolyline) map.removeLayer(routePolyline);
            const points = polyline.decode(data.routes[0].geometry);
            routePolyline = L.polyline(points, {
                color: '#0070ff', weight: 6, opacity: 0.8,
                dashArray: '10, 15'
            }).addTo(map);
            map.fitBounds(routePolyline.getBounds(), { padding: [40, 40] });
        }
    }

    function adjustPrice(val) {
        currentPrice = Math.max(100, currentPrice + val);
        document.getElementById('display_price').innerText = currentPrice + " ‚ÇΩ";
    }

    function confirmOrder() {
        const from = document.getElementById('from').value;
        const to = document.getElementById('to').value;
        if (!from || !to) return tg.showAlert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∞–¥—Ä–µ—Å–∞");
        tg.sendData(JSON.stringify({ from, to, price: currentPrice, coords }));
        tg.close();
    }
</script>
</body>
</html>
