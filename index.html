<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Aqua Taxi WebApp</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --bg-color: #001219;
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --accent-teal: #94d2bd;
            --accent-dark-teal: #0a9396;
            --accent-orange: #ee9b00;
            --text-main: #e9d8a6;
            --text-white: #ffffff;
            --blur-val: 25px;
            --anim-bezier: cubic-bezier(0.2, 0, 0, 1);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            margin: 0;
            padding: 0;
            font-family: 'Montserrat', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-white);
            overflow-x: hidden;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding-bottom: 20px;
        }

        /* --- Background Animation --- */
        .background-anim {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1;
            overflow: hidden;
        }
        .bubble {
            position: absolute;
            bottom: -100px;
            background: radial-gradient(circle, rgba(0,95,115,0.4) 0%, rgba(0,0,0,0) 70%);
            border-radius: 50%;
            animation: floatUp 15s infinite linear;
        }
        @keyframes floatUp {
            0% { transform: translateY(0) scale(1); opacity: 0; }
            50% { opacity: 0.6; }
            100% { transform: translateY(-120vh) scale(1.5); opacity: 0; }
        }

        /* --- Header --- */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            z-index: 10;
        }
        h1 { margin: 0; font-size: 24px; font-weight: 700; color: var(--accent-teal); text-shadow: 0 0 10px rgba(148, 210, 189, 0.3); }

        .music-toggle {
            width: 40px; height: 40px;
            border-radius: 50%;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            backdrop-filter: blur(var(--blur-val));
            transition: all 0.3s var(--anim-bezier);
        }
        .music-toggle.active { box-shadow: 0 0 15px var(--accent-teal); border-color: var(--accent-teal); }

        /* --- Container --- */
        .container { padding: 0 16px; width: 100%; max-width: 500px; margin: 0 auto; }

        /* --- Glass Cards --- */
        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(var(--blur-val));
            -webkit-backdrop-filter: blur(var(--blur-val));
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        /* --- Inputs --- */
        .input-group { position: relative; margin-bottom: 12px; }
        .input-group:last-child { margin-bottom: 0; }
        
        input[type="text"] {
            width: 100%;
            background: rgba(0,0,0,0.2);
            border: 1px solid transparent;
            padding: 14px 14px 14px 40px;
            border-radius: 12px;
            color: white;
            font-family: inherit;
            font-size: 16px;
            transition: all 0.2s;
        }
        input[type="text"]:focus {
            outline: none;
            border-color: var(--accent-teal);
            box-shadow: 0 0 10px rgba(148,210,189,0.2);
        }
        .input-icon {
            position: absolute; left: 14px; top: 50%;
            transform: translateY(-50%);
            color: var(--accent-teal);
        }
        .remove-btn, .add-stop-btn {
            color: var(--accent-orange);
            font-size: 14px;
            background: none; border: none;
            cursor: pointer;
            padding: 5px;
            margin-top: 5px;
        }

        /* --- Suggestions (DaData) --- */
        .suggestions-list {
            background: #001e29;
            border-radius: 12px;
            margin-top: 5px;
            max-height: 200px;
            overflow-y: auto;
            position: absolute;
            width: 100%;
            z-index: 100;
            display: none;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
            border: 1px solid var(--glass-border);
        }
        .suggestion-item {
            padding: 12px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            font-size: 14px;
        }
        .suggestion-item:active { background: var(--accent-dark-teal); }

        /* --- Scrubbing Areas (Car Class & Payment) --- */
        .scrub-container {
            display: flex;
            background: rgba(0,0,0,0.3);
            border-radius: 16px;
            padding: 4px;
            position: relative;
            touch-action: none; /* Важно для свайпов */
            margin-bottom: 15px;
            justify-content: space-between;
        }

        .scrub-item {
            flex: 1;
            text-align: center;
            padding: 12px 0;
            font-size: 14px;
            font-weight: 600;
            color: rgba(255,255,255,0.6);
            border-radius: 12px;
            transition: all 0.2s var(--anim-bezier);
            position: relative;
            z-index: 2;
            user-select: none;
        }
        .scrub-item.active {
            color: #001219;
            transform: scale(0.95);
        }
        
        /* Плавающая подложка для активации */
        .scrub-bg {
            position: absolute;
            top: 4px; left: 4px;
            height: calc(100% - 8px);
            background: var(--accent-teal);
            border-radius: 12px;
            z-index: 1;
            transition: transform 0.15s var(--anim-bezier), width 0.15s var(--anim-bezier);
            box-shadow: 0 0 15px var(--accent-teal);
        }

        /* --- Price & Options --- */
        .options-row {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 10px;
        }
        .price-control {
            display: flex; align-items: center; gap: 15px;
            background: rgba(0,0,0,0.2); padding: 5px 10px; border-radius: 12px;
        }
        .price-btn {
            width: 30px; height: 30px;
            border-radius: 8px;
            background: var(--glass-border);
            border: none; color: white;
            font-size: 18px;
            display: flex; align-items: center; justify-content: center;
        }
        .current-price { font-weight: 700; color: var(--accent-orange); font-size: 18px; }

        .file-upload-btn {
            background: rgba(0,0,0,0.2);
            color: var(--accent-teal);
            border: 1px solid var(--glass-border);
            padding: 10px;
            border-radius: 12px;
            cursor: pointer;
            display: flex; align-items: center; gap: 8px;
            font-size: 14px;
        }
        #photo-input { display: none; }

        /* --- Main Button --- */
        .order-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, var(--accent-orange), #ca6702);
            border: none;
            border-radius: 16px;
            color: white;
            font-size: 18px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 5px 20px rgba(238, 155, 0, 0.4);
            margin-top: 10px;
            transition: transform 0.1s;
        }
        .order-btn:active { transform: scale(0.96); }

        .price-display-large {
            text-align: center;
            font-size: 32px;
            font-weight: 800;
            color: var(--text-white);
            margin: 10px 0;
            text-shadow: 0 0 20px rgba(255,255,255,0.2);
        }

    </style>
</head>
<body>

    <div class="background-anim" id="bg-anim"></div>
    <audio id="bg-music" loop src="Ringtone.mp3"></audio>

    <header>
        <h1>AquaTaxi</h1>
        <div class="music-toggle" id="music-btn">
            <i class="fas fa-music" style="color: var(--accent-teal);"></i>
        </div>
    </header>

    <div class="container">
        
        <div class="glass-card">
            <div class="input-group">
                <i class="fas fa-location-dot input-icon"></i>
                <input type="text" id="address-from" placeholder="Откуда" autocomplete="off">
                <div class="suggestions-list" id="suggestions-from"></div>
            </div>
            
            <div id="intermediate-container"></div>
            
            <button class="add-stop-btn" id="add-stop-btn">+ Заезд</button>

            <div class="input-group" style="margin-top: 12px;">
                <i class="fas fa-flag-checkered input-icon"></i>
                <input type="text" id="address-to" placeholder="Куда" autocomplete="off">
                <div class="suggestions-list" id="suggestions-to"></div>
            </div>
        </div>

        <div class="glass-card">
            <div style="margin-bottom: 8px; font-size: 12px; color: #aaa;">Класс авто</div>
            <div class="scrub-container" id="class-scrubber">
                <div class="scrub-bg" id="class-bg"></div>
                <div class="scrub-item active" data-class="econom" data-price="300">Эконом</div>
                <div class="scrub-item" data-class="comfort" data-price="500">Комфорт</div>
                <div class="scrub-item" data-class="business" data-price="900">Бизнес</div>
            </div>
            
            <div class="price-display-large" id="main-price-display">300 ₽</div>
        </div>

        <div class="glass-card">
            <div class="options-row">
                <div class="price-control">
                    <button class="price-btn" id="price-minus">−</button>
                    <span class="current-price" id="extra-price">0</span>
                    <button class="price-btn" id="price-plus">+</button>
                </div>
                
                <label class="file-upload-btn">
                    <i class="fas fa-camera"></i>
                    <span id="file-label">Фото</span>
                    <input type="file" id="photo-input" accept="image/*">
                </label>
            </div>
            
            <div class="input-group">
                <i class="fas fa-comment input-icon"></i>
                <input type="text" id="comment" placeholder="Комментарий к заказу">
            </div>
        </div>

        <div class="glass-card">
             <div style="margin-bottom: 8px; font-size: 12px; color: #aaa;">Способ оплаты</div>
             <div class="scrub-container" id="payment-scrubber">
                <div class="scrub-bg" id="payment-bg"></div>
                <div class="scrub-item active" data-pay="cash">Наличные</div>
                <div class="scrub-item" data-pay="sbp">СБП</div>
            </div>
        </div>

        <button class="order-btn" id="order-btn">Заказать такси</button>
    </div>

    <script>
        // --- 1. CONFIG & STATE ---
        const DADATA_TOKEN = "YOUR_API_KEY_HERE"; // Вставьте ваш ключ!
        const tg = window.Telegram.WebApp;
        
        let state = {
            basePrice: 300,
            extraPrice: 0,
            carClass: 'econom',
            paymentMethod: 'cash',
            stops: [],
            addresses: { from: '', to: '' },
            musicPlaying: false
        };

        // Инициализация Telegram
        tg.expand();
        tg.MainButton.hide(); // Используем свою кнопку

        // --- 2. BACKGROUND ANIMATION ---
        function createBubbles() {
            const bg = document.getElementById('bg-anim');
            for(let i=0; i<15; i++) {
                let b = document.createElement('div');
                b.className = 'bubble';
                let size = Math.random() * 60 + 20;
                b.style.width = size + 'px';
                b.style.height = size + 'px';
                b.style.left = Math.random() * 100 + '%';
                b.style.animationDelay = Math.random() * 10 + 's';
                b.style.animationDuration = (Math.random() * 10 + 10) + 's';
                bg.appendChild(b);
            }
        }
        createBubbles();

        // --- 3. SCRUBBING LOGIC (Tactile Selection) ---
        function setupScrubbing(containerId, bgId, onSelect) {
            const container = document.getElementById(containerId);
            const bg = document.getElementById(bgId);
            const items = container.querySelectorAll('.scrub-item');
            
            function updateSelection(targetItem) {
                if (!targetItem || !targetItem.classList.contains('scrub-item')) return;
                
                // Визуал
                items.forEach(i => i.classList.remove('active'));
                targetItem.classList.add('active');
                
                // Двигаем фон
                const rect = targetItem.getBoundingClientRect();
                const parentRect = container.getBoundingClientRect();
                bg.style.width = rect.width + 'px';
                bg.style.transform = `translateX(${rect.left - parentRect.left - 4}px)`; // -4 padding correction

                // Haptics & Callback
                tg.HapticFeedback.impactOccurred('light');
                onSelect(targetItem);
            }

            // Init position
            updateSelection(container.querySelector('.active'));

            // Touch Events
            container.addEventListener('touchstart', (e) => {
                const touch = e.touches[0];
                const target = document.elementFromPoint(touch.clientX, touch.clientY);
                updateSelection(target);
            }, {passive: false});

            container.addEventListener('touchmove', (e) => {
                e.preventDefault(); // Stop scroll
                const touch = e.touches[0];
                const target = document.elementFromPoint(touch.clientX, touch.clientY);
                if (target && target.classList.contains('scrub-item') && !target.classList.contains('active')) {
                    updateSelection(target);
                }
            }, {passive: false});
            
            // Mouse Events (для десктоп тестов)
            items.forEach(item => {
                item.addEventListener('click', () => updateSelection(item));
            });
        }

        // Setup Car Class Scrubbing
        setupScrubbing('class-scrubber', 'class-bg', (item) => {
            state.carClass = item.dataset.class;
            state.basePrice = parseInt(item.dataset.price);
            updatePriceDisplay();
        });

        // Setup Payment Scrubbing
        setupScrubbing('payment-scrubber', 'payment-bg', (item) => {
            state.paymentMethod = item.dataset.pay;
        });

        // --- 4. PRICE & OPTIONS LOGIC ---
        function updatePriceDisplay() {
            const total = state.basePrice + state.extraPrice;
            document.getElementById('main-price-display').innerText = `${total} ₽`;
            document.getElementById('extra-price').innerText = state.extraPrice > 0 ? `+${state.extraPrice}` : state.extraPrice;
        }

        document.getElementById('price-plus').addEventListener('click', () => {
            state.extraPrice += 100;
            tg.HapticFeedback.selectionChanged();
            updatePriceDisplay();
        });

        document.getElementById('price-minus').addEventListener('click', () => {
            state.extraPrice -= 100;
            tg.HapticFeedback.selectionChanged();
            updatePriceDisplay();
        });

        // Photo Upload Feedback
        document.getElementById('photo-input').addEventListener('change', (e) => {
            const label = document.getElementById('file-label');
            if (e.target.files.length > 0) {
                label.innerText = "Фото загружено";
                label.style.color = "var(--text-white)";
            }
        });

        // --- 5. ADDRESS & DADATA INTEGRATION ---
        
        async function fetchSuggestions(query) {
            if (!query || query.length < 3) return [];
            const url = "https://suggestions.dadata.ru/suggestions/api/4_1/rs/suggest/address";
            
            try {
                const response = await fetch(url, {
                    method: "POST",
                    mode: "cors",
                    headers: {
                        "Content-Type": "application/json",
                        "Accept": "application/json",
                        "Authorization": "Token " + DADATA_TOKEN
                    },
                    body: JSON.stringify({ 
                        query: query, 
                        count: 5,
                        locations: [{ city_fias_id: null }] // Можно зафиксировать город здесь при геолокации
                    })
                });
                const data = await response.json();
                return data.suggestions;
            } catch (error) {
                console.error(error);
                return [];
            }
        }

        function setupAutocomplete(inputId, listId, onSelect) {
            const input = document.getElementById(inputId);
            const list = document.getElementById(listId);
            
            // Auto-hide keyboard on scroll
            window.addEventListener('scroll', () => {
                if(document.activeElement === input) input.blur();
            });

            // Start music on input interaction
            input.addEventListener('focus', () => {
                if(!state.musicPlaying && localStorage.getItem('musicEnabled') === 'true') {
                    document.getElementById('bg-music').play().catch(e => console.log(e));
                    state.musicPlaying = true;
                }
            });

            input.addEventListener('input', async () => {
                const query = input.value;
                if(query.length < 3) { list.style.display = 'none'; return; }
                
                const suggestions = await fetchSuggestions(query);
                list.innerHTML = '';
                
                suggestions.forEach(sg => {
                    const div = document.createElement('div');
                    div.className = 'suggestion-item';
                    // Clean prefix logic (simple version)
                    let text = sg.value; 
                    div.innerText = text;
                    
                    div.addEventListener('click', () => {
                        input.value = text;
                        list.style.display = 'none';
                        onSelect(sg);
                        tg.HapticFeedback.impactOccurred('medium');
                    });
                    list.appendChild(div);
                });
                
                if(suggestions.length > 0) list.style.display = 'block';
            });
            
            // Hide on outside click
            document.addEventListener('click', (e) => {
                if (e.target !== input && e.target !== list) list.style.display = 'none';
            });
        }

        setupAutocomplete('address-from', 'suggestions-from', (data) => state.addresses.from = data.value);
        setupAutocomplete('address-to', 'suggestions-to', (data) => state.addresses.to = data.value);

        // Промежуточные адреса
        document.getElementById('add-stop-btn').addEventListener('click', () => {
            const container = document.getElementById('intermediate-container');
            const id = 'stop-' + Date.now();
            
            const div = document.createElement('div');
            div.className = 'input-group';
            div.innerHTML = `
                <i class="fas fa-map-pin input-icon"></i>
                <input type="text" id="${id}" placeholder="Заезд">
                <div class="suggestions-list" id="sugg-${id}"></div>
            `;
            container.appendChild(div);
            
            setupAutocomplete(id, `sugg-${id}`, (data) => {
                state.stops.push(data.value);
            });
        });

        // --- 6. MUSIC & UTILS ---
        const musicBtn = document.getElementById('music-btn');
        const audio = document.getElementById('bg-music');
        
        // Restore state
        if (localStorage.getItem('musicEnabled') === 'true') {
            musicBtn.classList.add('active');
        }

        musicBtn.addEventListener('click', () => {
            const isEnabled = !musicBtn.classList.contains('active');
            musicBtn.classList.toggle('active');
            localStorage.setItem('musicEnabled', isEnabled);
            
            if (isEnabled) {
                audio.play();
                state.musicPlaying = true;
            } else {
                audio.pause();
                state.musicPlaying = false;
            }
            tg.HapticFeedback.selectionChanged();
        });

        // --- 7. FINAL ORDER ---
        document.getElementById('order-btn').addEventListener('click', () => {
            // Validate House Number (Basic regex check for digit)
            const hasDigit = /\d/.test(document.getElementById('address-from').value);
            
            if (!document.getElementById('address-from').value || !hasDigit) {
                tg.showAlert("Пожалуйста, укажите точный адрес подачи (с номером дома)");
                tg.HapticFeedback.notificationOccurred('error');
                return;
            }

            const orderData = {
                ...state,
                comment: document.getElementById('comment').value,
                totalPrice: state.basePrice + state.extraPrice
            };

            tg.sendData(JSON.stringify(orderData));
            tg.HapticFeedback.notificationOccurred('success');
            // tg.close(); // Опционально закрыть окно
        });

    </script>
</body>
</html>
