<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Liquid Aqua Taxi</title>
    
    <!-- –£–±—Ä–∞–Ω—ã –≤–Ω–µ—à–Ω–∏–µ —à—Ä–∏—Ñ—Ç—ã –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏ -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- –°—Ç–∏–ª—å –¥–ª—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –∑–∞–≥—Ä—É–∑–∫–∏ -->
    <style>
        .tg-loader {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 18, 25, 0.95);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        .loader-spinner {
            width: 50px; height: 50px;
            border: 3px solid rgba(148, 210, 189, 0.3);
            border-radius: 50%;
            border-top-color: #0a9396;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
    
    <style>
        :root { 
            --aqua-bright: #0a9396;
            --neon-blue: #94d2bd;
            --glass-bg: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.15);
            --dark-bg: #001219;
            --warning-orange: #ee9b00;
        }

        /* –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–µ —à—Ä–∏—Ñ—Ç—ã –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ */
        * { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
        }
        
        body { 
            background: var(--dark-bg);
            color: #fff; 
            margin: 0; 
            padding: 15px; 
            min-height: 100vh; 
            overflow-x: hidden;
            display: flex; 
            flex-direction: column;
        }

        .aqua-bg {
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%;
            z-index: -1; 
            background: linear-gradient(180deg, #001219 0%, #005f73 100%);
            overflow: hidden;
        }
        
        .drop {
            position: absolute; 
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(5px); 
            border-radius: 50%;
            animation: flow 15s infinite linear;
            will-change: transform, opacity; /* –£—Å–∫–æ—Ä–µ–Ω–∏–µ –∞–Ω–∏–º–∞—Ü–∏–∏ */
            transform: translateZ(0);
        }
        
        @keyframes flow {
            0% { transform: translateY(110vh) scale(0.5); opacity: 0; }
            100% { transform: translateY(-10vh) scale(1.2); opacity: 0; }
        }

        .music-switch-container {
            position: fixed; 
            top: 15px; 
            right: 15px;
            z-index: 2000; 
            display: flex; 
            align-items: center; 
            gap: 8px;
            background: var(--glass-bg); 
            padding: 8px 12px;
            border-radius: 20px; 
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(10px); 
            -webkit-backdrop-filter: blur(10px);
        }
        
        .switch { 
            position: relative; 
            display: inline-block; 
            width: 40px; 
            height: 20px; 
        }
        
        .switch input { 
            opacity: 0; 
            width: 0; 
            height: 0; 
        }
        
        .slider {
            position: absolute; 
            cursor: pointer; 
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 0;
            background-color: rgba(255,255,255,0.1); 
            transition: .4s; 
            border-radius: 20px;
            border: 1px solid var(--glass-border);
        }
        
        .slider:before {
            position: absolute; 
            content: ""; 
            height: 14px; 
            width: 14px;
            left: 3px; 
            bottom: 2px; 
            background-color: white; 
            transition: .4s; 
            border-radius: 50%;
        }
        
        input:checked + .slider { 
            background-color: var(--aqua-bright); 
            border-color: var(--neon-blue); 
            box-shadow: 0 0 10px rgba(148, 210, 189, 0.4); 
        }
        
        input:checked + .slider:before { 
            transform: translateX(18px); 
        }
        
        .music-label { 
            font-size: 9px; 
            font-weight: 800; 
            color: var(--neon-blue); 
            text-transform: uppercase; 
        }

        .container { 
            background: var(--glass-bg); 
            backdrop-filter: blur(25px); 
            -webkit-backdrop-filter: blur(25px);
            border: 1px solid var(--glass-border); 
            border-radius: 30px; 
            padding: 20px; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.3); 
            margin-top: 50px;
        }

        .top-info-row { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 15px; 
        }
        
        .version-label { 
            font-size: 10px; 
            color: var(--neon-blue); 
            opacity: 0.6; 
            font-weight: 800; 
        }
        
        #city-status { 
            font-size: 10px; 
            font-weight: 800; 
            color: #94d2bd; 
            cursor: pointer; 
            text-transform: uppercase; 
            padding: 4px 8px;
            background: rgba(148, 210, 189, 0.1);
            border-radius: 10px;
        }

        .field-group { 
            margin-bottom: 18px; 
            position: relative; 
        }
        
        label { 
            font-size: 11px; 
            font-weight: 800; 
            color: var(--neon-blue); 
            text-transform: uppercase; 
            display: block; 
            margin-bottom: 8px; 
            margin-left: 5px; 
        }
        
        input[type="text"] { 
            width: 100%; 
            padding: 16px; 
            border: 1px solid var(--glass-border); 
            border-radius: 18px; 
            background: rgba(0, 18, 25, 0.4); 
            color: #fff; 
            outline: none; 
            font-size: 15px; 
            transition: 0.4s;
        }
        
        input[type="text"]:focus { 
            border-color: #94d2bd; 
            background: rgba(0, 18, 25, 0.6); 
        }

        .btn-add-point { 
            display: block; 
            width: fit-content; 
            margin: -5px auto 15px 5px;
            color: #94d2bd; 
            font-size: 11px; 
            font-weight: 800; 
            border: none; 
            background: none; 
            cursor: pointer; 
            text-transform: uppercase; 
            padding: 5px 0;
        }

        .suggestions { 
            position: absolute; 
            top: 100%; 
            left: 0; 
            right: 0; 
            background: rgba(0, 18, 25, 0.98); 
            backdrop-filter: blur(15px);
            border: 1px solid var(--glass-border); 
            border-radius: 18px; 
            z-index: 1000; 
            display: none; 
            max-height: 200px; 
            overflow-y: auto; 
            margin-top: 5px;
        }
        
        .suggestion-item { 
            padding: 15px; 
            border-bottom: 1px solid rgba(255,255,255,0.05); 
            font-size: 14px; 
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .suggestion-item:hover {
            background: rgba(148, 210, 189, 0.1);
        }

        .class-selector { 
            display: flex; 
            gap: 8px; 
            margin-bottom: 20px; 
        }
        
        .class-btn { 
            flex: 1; 
            padding: 12px 5px; 
            border-radius: 15px; 
            border: 1px solid var(--glass-border);
            background: rgba(255, 255, 255, 0.05); 
            color: rgba(255, 255, 255, 0.7); 
            font-size: 10px; 
            font-weight: 800; 
            text-transform: uppercase; 
            text-align: center;
            cursor: pointer;
        }
        
        .class-btn.active { 
            background: linear-gradient(135deg, #0a9396, #94d2bd); 
            color: #001219; 
            border: none; 
        }

        .price-section { 
            background: linear-gradient(145deg, rgba(255,255,255,0.08), rgba(255,255,255,0.02));
            border-radius: 25px; 
            padding: 20px; 
            margin: 25px 0; 
            border: 1px solid var(--glass-border); 
            text-align: center;
        }
        
        .price-display { 
            font-size: 34px; 
            font-weight: 800; 
            color: #ee9b00; 
            margin: 0 15px; 
        }
        
        .btn-round { 
            width: 50px; 
            height: 50px; 
            border-radius: 15px; 
            background: var(--glass-bg); 
            color: #fff; 
            font-size: 24px; 
            border: 1px solid var(--glass-border);
            cursor: pointer;
        }

        .pay-row { 
            display:flex; 
            gap:10px; 
            margin-bottom: 20px; 
        }
        
        .pay-btn { 
            flex: 1; 
            padding: 16px; 
            border-radius: 18px; 
            border: 1px solid var(--glass-border); 
            background: rgba(255,255,255,0.05); 
            color: #fff; 
            font-size: 11px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 8px; 
            cursor: pointer;
        }
        
        .pay-btn.active { 
            background: rgba(148, 210, 189, 0.2); 
            border-color: #94d2bd; 
        }
        
        .pay-icon { 
            width: 20px; 
            height: 20px; 
            border-radius: 4px; 
        }

        .order-button { 
            width: 100%; 
            padding: 22px; 
            background: linear-gradient(90deg, #ee9b00, #ca6702); 
            color: #fff; 
            border: none; 
            border-radius: 22px; 
            font-size: 18px; 
            font-weight: 800; 
            text-transform: uppercase; 
            cursor: pointer;
        }
        
        #city-selector-box { 
            display: none; 
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ */
        .input-error {
            border-color: #ff6b6b !important;
            animation: shake 0.5s;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }

        .error-message {
            color: #ff6b6b;
            font-size: 11px;
            margin-top: 5px;
            margin-left: 5px;
            display: none;
        }

        /* –°—Ç–∏–ª—å –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏ –∑–∞–∫–∞–∑–æ–≤ */
        .history-badge {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 100;
        }
    </style>
</head>
<body>

<!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
<div class="tg-loader" id="global-loader">
    <div class="loader-spinner"></div>
    <div style="margin-top: 15px; color: var(--neon-blue); font-size: 12px;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
</div>

<div class="aqua-bg" id="aqua-bg"></div>

<!-- –ë–µ–π–¥–∂ –∏—Å—Ç–æ—Ä–∏–∏ -->
<div class="history-badge" onclick="showOrderHistory()" title="–ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤">
    üìã
</div>

<div class="music-switch-container">
    <span class="music-label">MUSIC</span>
    <label class="switch">
        <input type="checkbox" id="music-toggle" onchange="manualMusicControl()">
        <span class="slider"></span>
    </label>
</div>

<audio id="bg-audio" loop preload="metadata">
    <source src="https://assets.mixkit.co/music/preview/mixkit-tech-house-vibes-130.mp3" type="audio/mpeg">
</audio>

<div class="container">
    <div class="top-info-row">
        <div class="version-label">v 3.0 | OPTIMIZED</div>
        <div id="city-status" onclick="toggleCitySelector()">–ì–û–†–û–î: –û–ü–†–ï–î–ï–õ–ï–ù–ò–ï...</div>
    </div>
    
    <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ -->
    <div id="geo-loading" style="display:none; text-align:center; padding:10px; color:var(--neon-blue);">
        –û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ...
    </div>
    
    <div id="city-selector-box" class="field-group">
        <label>–í—ã–±–æ—Ä –≥–æ—Ä–æ–¥–∞:</label>
        <input type="text" id="city-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –≥–æ—Ä–æ–¥" oninput="getCitySuggestions(this)" onkeydown="checkEnter(event, this)">
        <div class="suggestions"></div>
    </div>

    <div class="field-group">
        <label>–û—Ç–∫—É–¥–∞:</label>
        <input type="text" id="from" placeholder="–£–ª–∏—Ü–∞ –∏ –¥–æ–º (–Ω–∞–ø—Ä–∏–º–µ—Ä: –õ–µ–Ω–∏–Ω–∞ 10)" oninput="getSuggestions(this)" onfocus="autoPlayMusic()" onkeydown="checkEnter(event, this)">
        <div class="error-message" id="from-error"></div>
        <div class="suggestions"></div>
    </div>

    <div id="extra-stops"></div>
    <button class="btn-add-point" onclick="addStopField()">+ –î–æ–±–∞–≤–∏—Ç—å –æ—Å—Ç–∞–Ω–æ–≤–∫—É</button>
    
    <div class="field-group">
        <label>–ö—É–¥–∞:</label>
        <input type="text" id="to" placeholder="–ú–µ—Å—Ç–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è" oninput="getSuggestions(this)" onfocus="autoPlayMusic()" onkeydown="checkEnter(event, this)">
        <div class="error-message" id="to-error"></div>
        <div class="suggestions"></div>
    </div>

    <div class="field-group">
        <label>–ö–ª–∞—Å—Å:</label>
        <div class="class-selector">
            <div class="class-btn active" onclick="selectClass('econom', 500)">–≠–∫–æ–Ω–æ–º</div>
            <div class="class-btn" onclick="selectClass('comfort', 700)">–ö–æ–º—Ñ–æ—Ä—Ç</div>
            <div class="class-btn" onclick="selectClass('business', 900)">–ë–∏–∑–Ω–µ—Å</div>
        </div>
    </div>

    <div class="field-group">
        <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</label>
        <input type="text" id="comment" placeholder="–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –≤–æ–¥–∏—Ç–µ–ª—è‚Ä¶" onfocus="autoPlayMusic()" onkeydown="checkEnter(event, this)">
    </div>

    <div class="price-section">
        <div class="price-row" style="display:flex; align-items:center; justify-content:center;">
            <button class="btn-round" onclick="adjustPrice(-100)">‚àí</button>
            <div class="price-display" id="display_price">500 ‚ÇΩ</div>
            <button class="btn-round" onclick="adjustPrice(100)">+</button>
        </div>
    </div>

    <div class="pay-row">
        <div id="pay-cash" class="pay-btn active" onclick="setPayment('–ù–∞–ª–∏—á–Ω—ã–µ')">–ù–ê–õ–ò–ß–ù–´–ï</div>
        <div id="pay-online" class="pay-btn" onclick="setPayment('–ü–ï–†–ï–í–û–î –°–ë–ü')">
            <!-- Placeholder –¥–ª—è –∏–∫–æ–Ω–∫–∏ –°–ë–ü -->
            <div class="pay-icon" style="background: #4CAF50; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 10px;">–°–ë–ü</div>
            –ü–ï–†–ï–í–û–î –°–ë–ü
        </div>
    </div>

    <button class="order-button" onclick="confirmOrder()">–ó–ê–ö–ê–ó–ê–¢–¨</button>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();
    tg.enableClosingConfirmation(); // –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏

    // API –∫–ª—é—á –î–û–õ–ñ–ï–ù –±—ã—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ! –≠—Ç–æ –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ
    // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ backend –ø—Ä–æ–∫—Å–∏
    const DADATA_API_KEY = "–í–ê–®_–ö–õ–Æ–ß_–ó–î–ï–°–¨"; // ‚ö†Ô∏è –ù–ï –ö–û–ú–ú–ò–¢–¨–¢–ï –†–ï–ê–õ–¨–ù–´–ô –ö–õ–Æ–ß –í GITHUB!

    const audio = document.getElementById('bg-audio');
    const musicToggle = document.getElementById('music-toggle');
    const globalLoader = document.getElementById('global-loader');

    // –ö—ç—à –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤
    const addressCache = new Map();
    const cityCache = new Map();
    
    // –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    let isPlaying = false;
    let basePrice = 500, manualAdjustment = 0;
    let paymentMethod = '–ù–∞–ª–∏—á–Ω—ã–µ', selectedClass = '–≠–∫–æ–Ω–æ–º';
    let searchTimeout, detectedCity = null;
    let geolocationAttempted = false;

    // –î–µ–±–∞—É–Ω—Å —Ñ—É–Ω–∫—Ü–∏—è
    function debounce(func, delay) {
        let timeout;
        return function(...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), delay);
        };
    }

    // --- –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã ---
    function closeAllUI(e) { 
        if (!e.target.closest('.field-group')) {
            document.activeElement.blur();
            document.querySelectorAll('.suggestions').forEach(s => s.style.display = 'none'); 
        }
    }

    function checkEnter(event, input) {
        if (event.key === "Enter") {
            input.blur();
            document.querySelectorAll('.suggestions').forEach(s => s.style.display = 'none');
        }
    }

    // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---
    window.addEventListener('DOMContentLoaded', () => {
        const savedMusicState = localStorage.getItem('musicEnabled');
        musicToggle.checked = (savedMusicState === null) ? true : (savedMusicState === 'true');
        
        // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π –∑–∞–∫–∞–∑
        restoreLastOrder();
        
        // –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≥–æ—Ä–æ–¥
        autoLocate();
        createDrops();
        
        // –ê–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥ —Ç–µ–º—É Telegram
        applyTheme();
    });

    // –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ç–µ–º—É Telegram
    function applyTheme() {
        if (tg.colorScheme === 'dark') {
            document.documentElement.style.setProperty('--dark-bg', '#1c1c1d');
            document.documentElement.style.setProperty('--glass-bg', 'rgba(255, 255, 255, 0.05)');
        }
    }

    // --- –ú—É–∑—ã–∫–∞ ---
    function autoPlayMusic() {
        if (!isPlaying && musicToggle.checked) {
            audio.play().then(() => {
                isPlaying = true;
            }).catch(err => {
                console.log("–ê–≤—Ç–æ–≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ:", err);
            });
        }
    }

    function manualMusicControl() {
        localStorage.setItem('musicEnabled', musicToggle.checked);
        if (musicToggle.checked) {
            audio.play().then(() => {
                isPlaying = true;
            }).catch(err => {
                console.log("–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è:", err);
            });
        } else {
            audio.pause();
            isPlaying = false;
        }
    }

    // --- –í–∏–∑—É–∞–ª—å–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã ---
    function createDrops() {
        const bg = document.getElementById('aqua-bg');
        for(let i = 0; i < 15; i++) {
            let d = document.createElement('div');
            d.className = 'drop';
            let s = Math.random() * 80 + 20;
            d.style.width = d.style.height = s + 'px';
            d.style.left = Math.random() * 100 + 'vw';
            d.style.animationDuration = (Math.random() * 10 + 10) + 's';
            bg.appendChild(d);
        }
    }

    function toggleCitySelector() { 
        const b = document.getElementById('city-selector-box'); 
        b.style.display = b.style.display === 'block' ? 'none' : 'block'; 
    }

    // --- –í–∞–ª–∏–¥–∞—Ü–∏—è –∞–¥—Ä–µ—Å–∞ ---
    function validateAddress(address) {
        if (!address || address.trim().length === 0) {
            return { isValid: false, message: "–ê–¥—Ä–µ—Å –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º" };
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –µ—Å—Ç—å –Ω–æ–º–µ—Ä –¥–æ–º–∞ (—Ü–∏—Ñ—Ä–∞)
        const hasHouseNumber = /\d/.test(address);
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –µ—Å—Ç—å —É–ª–∏—Ü–∞
        const hasStreet = /—É–ª\.|—É–ª[–∞-—è]?|–ø—Ä–æ—Å–ø\.|–ø—Ä–æ—Å–ø–µ–∫—Ç|–±—É–ª—å–≤\.|–±—É–ª—å–≤–∞—Ä|–ø—Ä–æ–µ–∑–¥|–ø–µ—Ä–µ—É–ª–æ–∫|—à–æ—Å—Å–µ|–Ω–∞–±\.|–ø–ª–æ—â–∞–¥—å/gi.test(address);
        
        if (!hasHouseNumber) {
            return { isValid: false, message: "–£–∫–∞–∂–∏—Ç–µ –Ω–æ–º–µ—Ä –¥–æ–º–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: '–õ–µ–Ω–∏–Ω–∞ 10')" };
        }
        
        if (!hasStreet && address.split(' ').length < 2) {
            return { isValid: false, message: "–£–∫–∞–∂–∏—Ç–µ —É–ª–∏—Ü—É –∏ –Ω–æ–º–µ—Ä –¥–æ–º–∞" };
        }
        
        return { isValid: true, message: "" };
    }

    // –ü–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É –≤–∞–ª–∏–¥–∞—Ü–∏–∏
    function showError(inputId, message) {
        const input = document.getElementById(inputId);
        const errorElement = document.getElementById(`${inputId}-error`);
        
        if (input && errorElement) {
            input.classList.add('input-error');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã—Ç—å –æ—à–∏–±–∫—É —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                input.classList.remove('input-error');
                errorElement.style.display = 'none';
            }, 3000);
        }
    }

    // --- –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫ ---
    function autoLocate() {
        if (geolocationAttempted) return;
        geolocationAttempted = true;
        
        document.getElementById('geo-loading').style.display = 'block';
        
        if (!navigator.geolocation) {
            document.getElementById('geo-loading').style.display = 'none';
            detectedCity = "–ú–æ—Å–∫–≤–∞";
            document.getElementById('city-status').innerText = "–ì–û–†–û–î: –ú–û–°–ö–í–ê";
            return;
        }

        // –¢–∞–π–º–∞—É—Ç –¥–ª—è –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏
        const timeout = new Promise((_, reject) => 
            setTimeout(() => reject(new Error('–¢–∞–π–º–∞—É—Ç –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏')), 10000)
        );

        const locationPromise = new Promise((resolve, reject) => {
            navigator.geolocation.getCurrentPosition(resolve, reject, {
                enableHighAccuracy: false,
                timeout: 8000,
                maximumAge: 300000
            });
        });

        Promise.race([locationPromise, timeout])
            .then(async (pos) => {
                try {
                    const response = await fetch("https://suggestions.dadata.ru/suggestions/api/4_1/rs/geolocate/address", {
                        method: "POST",
                        headers: { 
                            "Content-Type": "application/json",
                            "Authorization": "Token " + DADATA_API_KEY,
                            "Accept": "application/json"
                        },
                        body: JSON.stringify({ 
                            lat: pos.coords.latitude, 
                            lon: pos.coords.longitude,
                            count: 1
                        })
                    });
                    
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    
                    const data = await response.json();
                    if (data.suggestions && data.suggestions.length > 0) {
                        detectedCity = data.suggestions[0].data.city || "–ú–æ—Å–∫–≤–∞";
                        document.getElementById('city-status').innerText = "–ì–û–†–û–î: " + detectedCity.toUpperCase();
                        document.getElementById('from').value = cleanAddress(data.suggestions[0].value, detectedCity);
                        
                        // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≥–æ—Ä–æ–¥ –≤ localStorage
                        localStorage.setItem('last_city', detectedCity);
                    }
                } catch (error) {
                    console.warn("–û—à–∏–±–∫–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏:", error);
                    fallbackToDefaultCity();
                }
            })
            .catch((error) => {
                console.warn("–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ —É–¥–∞–ª–∞—Å—å:", error);
                fallbackToDefaultCity();
            })
            .finally(() => {
                document.getElementById('geo-loading').style.display = 'none';
            });
    }

    function fallbackToDefaultCity() {
        const lastCity = localStorage.getItem('last_city');
        detectedCity = lastCity || "–ú–æ—Å–∫–≤–∞";
        document.getElementById('city-status').innerText = "–ì–û–†–û–î: " + detectedCity.toUpperCase();
    }

    function cleanAddress(full, city) {
        if (!full) return "";
        let clean = full.replace("–†–æ—Å—Å–∏—è, ", "");
        if (city) {
            const cityReg = new RegExp("(–≥\\.?\\s?)?" + city + ",?\\s?", "gi");
            clean = clean.replace(cityReg, "");
        }
        return clean.replace(/^–≥\.?\s?/, "").trim();
    }

    // --- –ü–æ–∏—Å–∫ —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º ---
    const getSuggestions = debounce(async function(input) {
        let query = input.value.trim();
        let container = input.nextElementSibling.nextElementSibling; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç —Å –æ—à–∏–±–∫–æ–π
        
        if (query.length < 2) {
            container.style.display = 'none';
            return;
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫—ç—à
        const cacheKey = query + (detectedCity || '');
        if (addressCache.has(cacheKey)) {
            showSuggestions(addressCache.get(cacheKey), container, input);
            return;
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –≤ –ø–æ–¥—Å–∫–∞–∑–∫–∞—Ö
        container.innerHTML = '<div style="padding: 15px; color: var(--neon-blue); text-align: center;">–ü–æ–∏—Å–∫...</div>';
        container.style.display = 'block';
        
        try {
            const response = await fetch("https://suggestions.dadata.ru/suggestions/api/4_1/rs/suggest/address", {
                method: "POST",
                headers: { 
                    "Content-Type": "application/json",
                    "Authorization": "Token " + DADATA_API_KEY,
                    "Accept": "application/json"
                },
                body: JSON.stringify({ 
                    query: query, 
                    count: 5, 
                    locations: detectedCity ? [{city: detectedCity}] : [],
                    from_bound: {value: "city"},
                    to_bound: {value: "house"}
                })
            });
            
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            
            const data = await response.json();
            const suggestions = data.suggestions || [];
            
            // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –∫—ç—à
            addressCache.set(cacheKey, suggestions);
            
            // –û–≥—Ä–∞–Ω–∏—á–∏—Ç—å —Ä–∞–∑–º–µ—Ä –∫—ç—à–∞
            if (addressCache.size > 50) {
                const firstKey = addressCache.keys().next().value;
                addressCache.delete(firstKey);
            }
            
            showSuggestions(suggestions, container, input);
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –∞–¥—Ä–µ—Å–æ–≤:", error);
            container.innerHTML = '<div style="padding: 15px; color: #ff6b6b; text-align: center;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
        }
    }, 500);

    function showSuggestions(suggestions, container, input) {
        if (suggestions.length === 0) {
            container.innerHTML = '<div style="padding: 15px; color: rgba(255,255,255,0.5); text-align: center;">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
            return;
        }
        
        const fragment = document.createDocumentFragment();
        
        suggestions.forEach(suggestion => {
            const div = document.createElement('div');
            div.className = 'suggestion-item';
            div.textContent = cleanAddress(suggestion.value, detectedCity);
            
            div.onclick = () => {
                input.value = div.textContent;
                container.style.display = 'none';
                input.blur();
                
                // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –∞–¥—Ä–µ—Å–∞
                const validation = validateAddress(input.value);
                if (!validation.isValid) {
                    showError(input.id, validation.message);
                }
            };
            
            fragment.appendChild(div);
        });
        
        container.innerHTML = '';
        container.appendChild(fragment);
        container.style.display = 'block';
    }

    async function getCitySuggestions(input) {
        let query = input.value.trim();
        let container = input.nextElementSibling;
        
        if (query.length < 2) {
            container.style.display = 'none';
            return;
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫—ç—à
        if (cityCache.has(query)) {
            showCitySuggestions(cityCache.get(query), container, input);
            return;
        }
        
        try {
            const response = await fetch("https://suggestions.dadata.ru/suggestions/api/4_1/rs/suggest/address", {
                method: "POST",
                headers: { 
                    "Content-Type": "application/json",
                    "Authorization": "Token " + DADATA_API_KEY,
                    "Accept": "application/json"
                },
                body: JSON.stringify({ 
                    query: query, 
                    from_bound: {value: "city"}, 
                    to_bound: {value: "city"},
                    count: 5
                })
            });
            
            const data = await response.json();
            const suggestions = data.suggestions || [];
            
            // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –∫—ç—à
            cityCache.set(query, suggestions);
            
            showCitySuggestions(suggestions, container, input);
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –≥–æ—Ä–æ–¥–æ–≤:", error);
        }
    }

    function showCitySuggestions(suggestions, container, input) {
        container.innerHTML = '';
        suggestions.forEach(suggestion => {
            const div = document.createElement('div');
            div.className = 'suggestion-item';
            div.textContent = suggestion.value;
            
            div.onclick = () => {
                detectedCity = suggestion.data.city || suggestion.value;
                document.getElementById('city-status').innerText = "–ì–û–†–û–î: " + detectedCity.toUpperCase();
                toggleCitySelector();
                container.style.display = 'none';
                input.blur();
                
                // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≥–æ—Ä–æ–¥
                localStorage.setItem('last_city', detectedCity);
            };
            
            container.appendChild(div);
        });
        container.style.display = 'block';
    }

    // --- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º ---
    function addStopField() {
        const div = document.createElement('div');
        div.className = 'field-group';
        div.innerHTML = `
            <label>–û—Å—Ç–∞–Ω–æ–≤–∫–∞ <span style="color:#ee9b00; float:right; cursor:pointer;" onclick="this.parentElement.parentElement.remove()">‚úï</span></label>
            <input type="text" class="stop-input" placeholder="–ê–¥—Ä–µ—Å" oninput="getSuggestions(this)" onfocus="autoPlayMusic()" onkeydown="checkEnter(event, this)">
            <div class="suggestions"></div>`;
        document.getElementById('extra-stops').appendChild(div);
    }

    function selectClass(cls, price) {
        selectedClass = cls === 'econom' ? '–≠–∫–æ–Ω–æ–º' : (cls === 'comfort' ? '–ö–æ–º—Ñ–æ—Ä—Ç' : '–ë–∏–∑–Ω–µ—Å');
        basePrice = price;
        manualAdjustment = 0;
        document.querySelectorAll('.class-btn').forEach(b => b.classList.remove('active'));
        event.currentTarget.classList.add('active');
        updatePriceDisplay();
    }

    function adjustPrice(value) {
        const newPrice = basePrice + manualAdjustment + value;
        if (newPrice >= 100) {
            manualAdjustment += value;
            updatePriceDisplay();
        }
    }

    function updatePriceDisplay() {
        document.getElementById('display_price').textContent = (basePrice + manualAdjustment) + " ‚ÇΩ";
    }

    function setPayment(method) {
        paymentMethod = method;
        document.getElementById('pay-cash').classList.toggle('active', method === '–ù–∞–ª–∏—á–Ω—ã–µ');
        document.getElementById('pay-online').classList.toggle('active', method === '–ü–ï–†–ï–í–û–î –°–ë–ü');
    }

    // --- –ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤ ---
    function saveToHistory(order) {
        const history = JSON.parse(localStorage.getItem('taxi_history') || '[]');
        
        // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã (–ø–æ timestamp)
        const duplicate = history.find(item => 
            item.timestamp === order.timestamp
        );
        
        if (!duplicate) {
            history.unshift(order);
            
            // –û—Å—Ç–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 –∑–∞–∫–∞–∑–æ–≤
            if (history.length > 10) {
                history.pop();
            }
            
            localStorage.setItem('taxi_history', JSON.stringify(history));
        }
    }

    function restoreLastOrder() {
        const history = JSON.parse(localStorage.getItem('taxi_history') || '[]');
        if (history.length > 0) {
            const last = history[0];
            document.getElementById('from').value = last.from || '';
            document.getElementById('to').value = last.to || '';
            
            if (last.class) {
                const classMap = {
                    '–≠–∫–æ–Ω–æ–º': () => selectClass('econom', last.basePrice || 500),
                    '–ö–æ–º—Ñ–æ—Ä—Ç': () => selectClass('comfort', last.basePrice || 700),
                    '–ë–∏–∑–Ω–µ—Å': () => selectClass('business', last.basePrice || 900)
                };
                if (classMap[last.class]) classMap[last.class]();
            }
            
            if (last.payment) setPayment(last.payment);
        }
    }

    function showOrderHistory() {
        const history = JSON.parse(localStorage.getItem('taxi_history') || '[]');
        
        if (history.length === 0) {
            tg.showAlert('–ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤ –ø—É—Å—Ç–∞');
            return;
        }
        
        let message = "–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–∫–∞–∑—ã:\n\n";
        history.slice(0, 5).forEach((order, index) => {
            const date = new Date(order.timestamp).toLocaleDateString('ru-RU');
            message += `${index + 1}. ${order.from} ‚Üí ${order.to}\n`;
            message += `   ${order.price} ‚ÇΩ ‚Ä¢ ${date}\n\n`;
        });
        
        tg.showAlert(message);
    }

    // --- –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞ ---
    async function confirmOrder() {
        const from = document.getElementById('from').value.trim();
        const to = document.getElementById('to').value.trim();
        const comment = document.getElementById('comment').value.trim();
        
        // –í–∞–ª–∏–¥–∞—Ü–∏—è –∞–¥—Ä–µ—Å–æ–≤
        const fromValidation = validateAddress(from);
        const toValidation = validateAddress(to);
        
        if (!fromValidation.isValid) {
            showError('from', fromValidation.message);
            return;
        }
        
        if (!toValidation.isValid) {
            showError('to', toValidation.message);
            return;
        }
        
        // –°–æ–±—Ä–∞—Ç—å –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
        const stops = Array.from(document.querySelectorAll('.stop-input'))
            .map(input => input.value.trim())
            .filter(value => value.length > 0);
        
        // –°–æ–∑–¥–∞—Ç—å –æ–±—ä–µ–∫—Ç –∑–∞–∫–∞–∑–∞
        const order = {
            city: detectedCity || "–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω",
            from: from,
            to: to,
            inter: stops.length > 0 ? stops.join(', ') : "–ù–µ—Ç",
            car: selectedClass,
            price: basePrice + manualAdjustment,
            basePrice: basePrice,
            manualAdjustment: manualAdjustment,
            pay: paymentMethod,
            comment: comment,
            timestamp: new Date().toISOString(),
            user: tg.initDataUnsafe?.user?.id || 'anonymous'
        };
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram Popup
        const confirmed = await tg.showPopup({
            title: '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞',
            message: `–û—Ç: ${from}\n–ö—É–¥–∞: ${to}\n\n–ö–ª–∞—Å—Å: ${selectedClass}\n–¶–µ–Ω–∞: ${order.price} ‚ÇΩ\n–û–ø–ª–∞—Ç–∞: ${paymentMethod}`,
            buttons: [
                { id: 'confirm', type: 'default', text: '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å' },
                { id: 'cancel', type: 'destructive', text: '–û—Ç–º–µ–Ω–∏—Ç—å' }
            ]
        });
        
        if (confirmed.button_id === 'confirm') {
            // –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            globalLoader.style.display = 'flex';
            
            // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –∏—Å—Ç–æ—Ä–∏—é
            saveToHistory(order);
            
            // –ò–º–∏—Ç–∞—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏
            setTimeout(() => {
                try {
                    // –û—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ Telegram –±–æ—Ç–∞
                    tg.sendData(JSON.stringify(order));
                    
                    // –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
                    tg.showAlert('‚úÖ –ó–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω! –û–∂–∏–¥–∞–π—Ç–µ –≤–æ–¥–∏—Ç–µ–ª—è.');
                    
                    // –û—á–∏—Å—Ç–∏—Ç—å —Ñ–æ—Ä–º—É
                    document.getElementById('from').value = '';
                    document.getElementById('to').value = '';
                    document.getElementById('comment').value = '';
                    document.getElementById('extra-stops').innerHTML = '';
                    
                    // –°–±—Ä–æ—Å–∏—Ç—å —Ü–µ–Ω—É
                    selectClass('econom', 500);
                    
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', error);
                    tg.showAlert('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–∫–∞–∑–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
                } finally {
                    globalLoader.style.display = 'none';
                }
            }, 1500);
        }
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π Telegram
    tg.onEvent('viewportChanged', (event) => {
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫–∏ –ø—Ä–∏ –ø–æ—è–≤–ª–µ–Ω–∏–∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
        if (!event.isStateStable) {
            document.querySelectorAll('.suggestions').forEach(s => s.style.display = 'none');
        }
    });

    // –≠–∫—Å–ø–æ—Ä—Ç —Ñ—É–Ω–∫—Ü–∏–π –¥–ª—è –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
    window.toggleCitySelector = toggleCitySelector;
    window.getCitySuggestions = getCitySuggestions;
    window.getSuggestions = getSuggestions;
    window.checkEnter = checkEnter;
    window.addStopField = addStopField;
    window.selectClass = selectClass;
    window.adjustPrice = adjustPrice;
    window.setPayment = setPayment;
    window.confirmOrder = confirmOrder;
    window.manualMusicControl = manualMusicControl;
    window.autoPlayMusic = autoPlayMusic;
    window.closeAllUI = closeAllUI;
    window.showOrderHistory = showOrderHistory;
</script>
</body>
</html>
